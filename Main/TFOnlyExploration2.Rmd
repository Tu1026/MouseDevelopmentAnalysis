---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---
Setup
```{r}
library(tidyverse)
library(cowplot)
all_counts <- readRDS(file= "Data/pc_count_matrix.rds")
avg_counts <- readRDS(file="Data/avg_pc_count_matrix.rds")
diff_counts <- readRDS(file="Data/diff_pc_count_matrix.rds")
meta <- suppressMessages(readr::read_tsv("Data/complete_meta_data.tsv"))
meta <- meta %>% mutate(tissue_type=replace(tissue_type, tissue_type=="embryonic facial prominence", "facial prominence"))
meta <- meta %>% mutate(tissue_type=replace(tissue_type, tissue_type=="skeletal muscle tissue", "muscle tissue"))
meta <- meta %>% mutate(tissue_type=replace(tissue_type, tissue_type=="skeletal muscle tissue", "muscle tissue"))
tissue_types <- unique(meta %>% pull(tissue_type))
TFs<- suppressMessages(read_delim("mouse_tfs.tsv")) 
all_counts <- all_counts[rownames(all_counts) %in% (TFs %>% pull(Symbol)),]
avg_counts <- avg_counts[rownames(avg_counts) %in% (TFs %>% pull(Symbol)),]
collapsed_dev_counts <- matrix(data=NA, nrow=nrow(all_counts),ncol=length(tissue_types))
walker <- 1
for (tissue in tissue_types){
  tissue_subset_ids <- meta %>% filter(tissue_type == tissue) %>% pull(id)
  tissue_subset_count <- all_counts[,tissue_subset_ids]
  tissue_avg <- rowMeans(tissue_subset_count)
  collapsed_dev_counts[,walker] <- tissue_avg
  walker <- walker + 1
}
colnames(collapsed_dev_counts) <- tissue_types
rownames(collapsed_dev_counts) <- rownames(all_counts)
#TFs<- c("Ascl1", "Hes1", "Neurod1", "Mecp2", "Mef2c", "Runx1", "Tcf4", "Pax6")
```

PCA coloured by dev_stage
```{r fig.height=8, fig.width=16}
##Remove zero variance 
all_counts_drop_var <- (t(all_counts))[, which(apply(t(all_counts),2,var) !=0)]
all_counts.pca <- prcomp(all_counts_drop_var, center = TRUE,scale. = TRUE)
library(ggfortify)
library(ggrepel)
library(RColorBrewer)
autoplot(all_counts.pca, data=meta, colour="dev_stage", label.size = 3, size=5) + theme_cowplot(12) + scale_color_brewer(palette = "RdYlBu") 

```
PCA coloured by tissue
```{r fig.height=8, fig.width=16}
getPalette = colorRampPalette(brewer.pal(12, "Paired"))
autoplot(all_counts.pca, data=meta, colour="tissue_type", label.size = 3, size=5) + theme_cowplot(12) + scale_color_manual(values = getPalette(length(tissue_types))) 
```

Pearson correlation heatmap
```{r fig.height=16, fig.width=16, message=FALSE, warning=FALSE}

library(Hmisc)
all_counts_pear <- all_counts
colnames(all_counts_pear) <- sapply(colnames(all_counts), function(x){temp_row <- meta %>% filter(id==x) 
                                                                             return(paste0(temp_row %>% pull(tissue_type), " ",temp_row %>% pull(dev_stage)))})
pear_rcorr_object <- rcorr(all_counts_pear, type = "pearson")
pear_matrix <- pear_rcorr_object$r
pear_matrix_pvalues <- pear_rcorr_object$P
library(corrplot)

corrplot(pear_matrix, method = 'shade', type = 'lower', diag = FALSE, col = rep(rev(brewer.pal(n=8, name="RdYlBu")),2), col.lim=c(0,1))

```

Pearson correlation heatmap (collapsed by samples)
```{r fig.height=16, fig.width=16, warning=FALSE}
library(corrplot)
library(Hmisc)
avg_counts_pear <- avg_counts
colnames(avg_counts_pear) <- sapply(colnames(avg_counts), function(x){temp_row <- meta %>% filter(id==x) 
                                                                             return(paste0(temp_row %>% pull(tissue_type), " ",temp_row %>% pull(dev_stage)))})
pear_rcorr_object <- rcorr(avg_counts_pear, type = "pearson")
pear_matrix <- pear_rcorr_object$r
pear_matrix_pvalues <- pear_rcorr_object$P



corrplot(pear_matrix, method="shade", type="lower", diag=FALSE, col = rep(rev(brewer.pal(n=8, name="RdYlBu")),2), col.lim=c(0,1))

```

Pearson correlation heatmap (collapsed by samples) 17 clusters (because there are 17 tissues)
```{r fig.height=16, fig.width=16, warning=FALSE}
library(corrplot)
library(Hmisc)
avg_counts_pear <- avg_counts
colnames(avg_counts_pear) <- sapply(colnames(avg_counts), function(x){temp_row <- meta %>% filter(id==x) 
                                                                             return(paste0(temp_row %>% pull(tissue_type), " ",temp_row %>% pull(dev_stage)))})
pear_rcorr_object <- rcorr(avg_counts_pear, type = "pearson")
pear_matrix <- pear_rcorr_object$r
pear_matrix_pvalues <- pear_rcorr_object$P
testRes = cor.mtest(avg_counts_pear, conf.level = 0.95)


corrplot(pear_matrix, order = 'hclust', addrect = 17, method="shade", rect.col = 'black', col = rep(rev(brewer.pal(n=8, name="RdYlBu")),2), col.lim=c(0,1))

```
Pearson correlation heatmap (collapsed by samples)  8 clusters (because 8 unique dev stages)
```{r fig.height=16, fig.width=16, warning=FALSE}
library(corrplot)
library(Hmisc)
avg_counts_pear <- avg_counts
colnames(avg_counts_pear) <- sapply(colnames(avg_counts), function(x){temp_row <- meta %>% filter(id==x) 
                                                                             return(paste0(temp_row %>% pull(tissue_type), " ",temp_row %>% pull(dev_stage)))})
pear_rcorr_object <- rcorr(avg_counts_pear, type = "pearson")
pear_matrix <- pear_rcorr_object$r
pear_matrix_pvalues <- pear_rcorr_object$P
testRes = cor.mtest(avg_counts_pear, conf.level = 0.95)


corrplot(pear_matrix, order = 'hclust', addrect = 8, method="shade", rect.col = 'black', col = rep(rev(brewer.pal(n=8, name="RdYlBu")),2), col.lim=c(0,1))

```

Prepare Limma (with individual comparison)
```{r fig.height=16, fig.width=16, warning=FALSE}
# Demonstration of using limma to find differentially expressed genes

library(limma)
library(tidyverse)
library(edgeR)
library(tximport)

# load data
pc <- read.delim("Data/pc_sub.tsv", stringsAsFactors = FALSE)
files <- paste0("Data/Count_tables/", meta$id, ".tsv")
counts <- tximport(files, type = "rsem", txIn = FALSE)
count_mat <- counts$counts


# name matrix and only keep protein coding genes
rownames(count_mat) <- str_replace(rownames(count_mat), "\\.[:digit:]*$", "")
colnames(count_mat) <- meta$id
count_mat <- count_mat[rownames(count_mat) %in% pc$Gene_ID, ]
oldrownames <- data.frame(rownames(count_mat)) 
oldrownames <- oldrownames %>% rename(Gene_ID=colnames(oldrownames)[1])
rownames(count_mat) <- oldrownames %>% left_join(pc,"Gene_ID") %>% pull(Symbol)
count_mat <- count_mat[rownames(count_mat) %in% (TFs %>% pull(Symbol)),]

# order by tissue and dev stage
meta <- meta %>% group_by(tissue_type) %>% arrange(dev_stage, .by_group = TRUE)
count_mat <- count_mat[, meta$id]
stopifnot(identical(colnames(count_mat), meta$id))

# build design matrix
tissue_ <- factor(meta$tissue_type)
design <- model.matrix(~ 0 + tissue_)
#design <- model.matrix(~ meta$tissue_type * meta$dev_stage)

# edgeR: remove lowly expressed, scale normalize, and the log2 CPM transform
dge <- DGEList(count_mat)
keep <- filterByExpr(dge, design)
dge <- dge[keep, ]

# gene counts of removed
removed <- rowSums(count_mat[!keep,])
summary(removed)
count_mat[which.max(removed), ]

# scale normalization using TMM method (default)
dge <- calcNormFactors(dge)

# convert counts to log2CPM 
cpm_counts <- cpm(dge, log = TRUE, prior.count = 3)

# fit model with limma eBayes trend 
fit <- lmFit(cpm_counts, design)
fit <- eBayes(fit, trend=TRUE)

```

Extract all toptables into list
```{r fig.height=16, fig.width=16, warning=FALSE}
diff_list <- list() 
for(tissue in tissue_types){
  col_name <- paste0("tissue_", tissue)
  diff_list[tissue] <- list(topTable(fit,coef = col_name, number = Inf))
}


```

Using 0.05 as cutoff, the numbers of differential expressed genes per tissue
```{r fig.height=16, fig.width=20, warning=FALSE}
get_sig_diff <- function(x){
  return(x = length(which(x$adj.P.Val <= 0.05)))
}
sig_lengths <- sapply(diff_list, get_sig_diff, USE.NAMES = TRUE)
sig_lengths <- data.frame(sig_lengths)
sig_lengths <- sig_lengths %>% rownames_to_column()
ggplot(data=sig_lengths, aes(x=rowname, y=sig_lengths)) + geom_bar(stat='identity') +theme_cowplot() + theme(axis.text.x = element_text(size = 12, angle = 45, hjust = 1))
```



Put all toptables to named list









hebah top 10 diff expressed per tissue, point to hindbrain genes interesting
Inter tissue vs Intra tissue gene patterns across timme series
Histogram of how many differentially expressed per tissue
Heatmap shows top 10 adjusted p-value and show their logFC only keep upregulated
See the variance across the time series (find more variable and find paper)


